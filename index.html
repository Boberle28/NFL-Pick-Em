<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pigskin Pick'em Login</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2em;
    }
    input {
      padding: 0.5em;
      margin: 0.5em;
      width: 200px;
    }
    button {
      padding: 0.5em 1em;
      margin: 0.5em;
      cursor: pointer;
    }
    #status {
      margin-top: 1em;
      font-weight: bold;
    }

    .login-info {
  max-width: 600px;
  margin: 40px auto;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-family: sans-serif;
  color: #222;
  line-height: 1.6;
}

.login-info h2, .login-info h3 {
  color: #1a1a1a;
  margin-top: 1.2em;
}

.login-info ul {
  padding-left: 1.2em;
  list-style-type: disc;
}

.login-info li {
  margin-bottom: 8px;
}

.login-info code {
  background-color: #f0f0f0;
  padding: 2px 5px;
  border-radius: 4px;
  font-size: 0.95em;
}

.login-info .humor {
  margin-top: 20px;
  font-style: italic;
  color: #444;
}
  </style>
</head>
<body>
  <h1>Pigskin Pick'em Login</h1>
  <input id="username" type="text" placeholder="Username" /><br />
  <input id="password" type="text" placeholder="Password" /><br />
  <button id="login-btn">Login</button>
  <button id="create-btn">Create Account</button>

  <div id="status"></div>
  <div class="login-info">
  <h2>Welcome to Pigskin Pick'em</h2>
  <p>No fantasy football. No weird scoring systems. Just straight-up: <strong>pick the winner</strong>. Simple as that.</p>

  <h3>How it works:</h3>
  <ul>
    <li><strong>Betting windows</strong> open and close between each NFL week.</li>
    <li>Once the final game of a week finishes (usually Sunday or Monday night), the next week's window opens.</li>
    <li>The window closes when the first game of the next week kicks off.</li>
  </ul>

  <p>When you log in:</p>
  <ul>
    <li>If weâ€™re <strong>in an active week</strong>, you'll see when the next window opens.</li>
    <li>If weâ€™re <strong>between weeks</strong>, you'll see when the current one closes.</li>
  </ul>

  <p><strong>No picks after the window closes. No exceptions.</strong></p>
  <p><strong>One submission per week.</strong> Once you hit <em>Submit</em>, itâ€™s locked in. No take-backs.</p>

  <h3>About the Numbers:</h3>
  <p>Youâ€™ll see a number under each team:</p>
  <ul>
    <li>The favorite always has a value of <code>1.00</code>.</li>
    <li>
  Underdogs have a higher number â€” the higher it is, the more Vegas doubts them. 
  These numbers are locked in when the betting window opens, and theyâ€™re only pulled once per week, 
  so savvy timing might just work to your advantage. These numbers are used for tiebreakers.
</li>
  </ul>
  <ul>
    <li><strong>Wins come first.</strong></li>
    <li>If wins are tied, we total your <strong>points</strong> (based on the value of correct picks).</li>
    <li>Picking correct underdogs gives you an edge.</li>
  </ul>

  <h3>Payouts:</h3>
  <ul>
    <li><strong>1st place:</strong> Takes the big pot</li>
    <li><strong>2nd place:</strong> $100</li>
    <li><strong>3rd place:</strong> Gets their bet back</li>
  </ul>

  <p class="humor">And if you have a gambling problem, just remember:<br>
    <em>99% of gamblers quit just before they hit it big.</em><br>
    So donâ€™t be a quitter.
  </p>
</div>

</body>
<script src ="NamesAndSchedule.js"></script>

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    getDoc,
    addDoc,
    setDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    setPersistence, 
    browserSessionPersistence
  } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAHTX6gGorh3Flmvbw0THBfk9i7ILeZ2E4",
      authDomain: "football-pickem-1d2ab.firebaseapp.com",
      projectId: "football-pickem-1d2ab",
      storageBucket: "football-pickem-1d2ab.firebasestorage.app",
      messagingSenderId: "1065963734942",
      appId: "1:1065963734942:web:042b5fbe5082b9cd29788f",
      measurementId: "G-K8JV62VJ6P"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function PullUsers(){
      // Pull users and get wins
      const picksRef = collection(db, "picks");
      const snapshot = await getDocs(picksRef);

      PullUsersAndGetWins(snapshot);
    }
    
    PullUsers();

  window.addEventListener("DOMContentLoaded", async () => {

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const statusText = document.getElementById("status");

    await setPersistence(auth, browserSessionPersistence);

    function formatUsernameAsEmail(username) {
      return `${username}@fake.com`;
    }

    document.getElementById("login-btn").addEventListener("click", async () => {

      const trimmed = usernameInput.value.trim();
      const email = formatUsernameAsEmail(trimmed);
      const password = passwordInput.value.trim();
      
      let matchedPlayer = Object.values(players).find(p =>
                        p.username.toLowerCase() === trimmed.toLowerCase()
                      );

      let username = null;
      if(matchedPlayer){
        username = matchedPlayer.username;
      }

      try {
        localStorage.setItem("username", username);
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = "picks.html";
      } catch (err) {
        statusText.textContent = `â›” Login failed: ${err.message}`;
        statusText.style.color = "red";
        localStorage.removeItem("username");
      }
    });

    document.getElementById("create-btn").addEventListener("click", async () => {
      const trimmed = usernameInput.value.trim();
      const email = formatUsernameAsEmail(trimmed);
      const password = passwordInput.value.trim();

      let username = trimmed;

      try {
        // First make sure they didnt leave the username field empty
        if(trimmed === ""){
          statusText.textContent = "â›” You must enter a username";
          statusText.style.color = "red";
          return;
        }

        // Check for empty username and any chars in username that will trip up firestore
        
        const invalidChars = /[./#\[\]$?\\]/;

        if (!username.trim()) {
          statusText.textContent = "â›” You must enter a username";
          statusText.style.color = "red";
          return;
        } 
        else if (invalidChars.test(username)) {
          statusText.textContent = "â›” Username contains invalid characters: . / # [ ] $ ? \\";
          statusText.style.color = "red";
          return;
        } 
        else if (username.startsWith("__")) {
          statusText.textContent = "â›” Username cannot start with '__' (double underscores).";
          statusText.style.color = "red";
          return;
        }
        
        let matchedPlayer = Object.values(players).find(p =>
                        p.username.toLowerCase() === trimmed.toLowerCase()
                      );

        if (matchedPlayer) {
          statusText.textContent = "â›” That username is already taken.";
          statusText.style.color = "red";
          return;
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Store username in the firestore
        const storageId = username + "_" + password;
        localStorage.setItem("username", username);

        // Save username in Firestore
        const userRef = doc(db, "picks", user.uid);
        await setDoc(userRef, {
          username: storageId
        }, { merge: true });
        
        statusText.textContent = `âœ… Account created for ${usernameInput.value}`;
        statusText.style.color = "green";


        window.location.href = "picks.html";

      } catch (err) {
        statusText.textContent = `â›” Account creation failed: ${err.message}`;
        statusText.style.color = "red";
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const username = localStorage.getItem("username");
        statusText.textContent = `ðŸ”“ Logged in as ${username}`;
        statusText.style.color = "green";
      }
    });
  });
</script>

</html>
